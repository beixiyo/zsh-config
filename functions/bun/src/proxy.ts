#!/usr/bin/env bun

import { parseArgs } from 'node:util'

/**
 * Proxy helper for zsh:
 *
 * - setProxy: ç”Ÿæˆ export + git config çš„ shell ç‰‡æ®µ
 * - unsetProxy: ç”Ÿæˆ unset + git config æ¸…ç†çš„ shell ç‰‡æ®µ
 *
 * è®¾è®¡ç”¨æ³•ï¼ˆåœ¨ zsh é‡Œï¼‰ï¼š
 *
 *   # è®¾ç½®ä»£ç†ï¼ˆä¿æŒç°æœ‰å‘½ä»¤åï¼‰
 *   setProxy() {
 *     eval "$(~/.zsh/functions/bun/proxy.ts set "$@")"
 *   }
 *
 *   unsetProxy() {
 *     eval "$(~/.zsh/functions/bun/proxy.ts unset "$@")"
 *   }
 *
 * æ³¨æ„ï¼šæœ¬è„šæœ¬ä¸ä¼šç›´æ¥ä¿®æ”¹å½“å‰ shell ç¯å¢ƒï¼Œè€Œæ˜¯è¾“å‡º shell è¯­å¥ã€‚
 */

type ProxyCommand = 'set' | 'unset'

interface SetProxyOptions {
  url: string
  port: number
  noProxy: string
}

function isPort(value: string): boolean {
  return /^[0-9]+$/.test(value)
}

function isUrl(value: string): boolean {
  return value.includes('://')
}

function parseSetArgs(args: string[]): SetProxyOptions {
  const {
    values,
    positionals,
  } = parseArgs({
    args,
    options: {
      'port': {
        type: 'string',
        short: 'p',
      },
      'url': {
        type: 'string',
        short: 'u',
      },
      'no-proxy': {
        type: 'string',
        short: 'n',
      },
    },
    allowPositionals: true,
  })

  let url
    = typeof values.url === 'string' && values.url.length > 0
      ? values.url
      : 'http://127.0.0.1'

  let port: number
  if (typeof values.port === 'string') {
    if (!isPort(values.port)) {
      throw new Error(`ç«¯å£å‚æ•°é”™è¯¯: ${values.port}`)
    }
    port = Number(values.port)
  }
  else {
    port = 7890
  }

  const noProxy
    = typeof values['no-proxy'] === 'string' && values['no-proxy'].length > 0
      ? values['no-proxy']
      : 'localhost,127.0.0.1,::1,192.168.0.0/16,10.0.0.0/8'

  for (const arg of positionals) {
    if (isPort(arg)) {
      port = Number(arg)
    }
    else if (isUrl(arg)) {
      url = arg
    }
    else {
      throw new Error(
        `æœªçŸ¥å‚æ•°: ${arg}\n`
        + 'ç”¨æ³•: setProxy [URL] [ç«¯å£] | setProxy [-p|--port <ç«¯å£>] [-u|--url <URL>] [-n|--no-proxy <æ’é™¤åˆ—è¡¨>]\n'
        + 'ç¤ºä¾‹: setProxy 8080 | setProxy -p 8080 | setProxy --url http://proxy.example.com',
      )
    }
  }

  return { url, port, noProxy }
}

function buildSetProxyShell(opts: SetProxyOptions): string {
  const proxy = `${opts.url}:${opts.port}`
  const noProxy = opts.noProxy

  const lines = [
    `# generated by bun proxy.ts`,
    `echo "ğŸ”§ è®¾ç½®ä»£ç†: ${proxy}"`,
    `echo "ğŸš« æ’é™¤åœ°å€: ${noProxy}"`,
    `export http_proxy=${proxy}`,
    `export HTTP_PROXY=${proxy}`,
    `export https_proxy=${proxy}`,
    `export HTTPS_PROXY=${proxy}`,
    `export no_proxy=${noProxy}`,
    `export NO_PROXY=${noProxy}`,
    `git config --global http.proxy "${proxy}"`,
    `git config --global https.proxy "${proxy}"`,
    `echo "âœ… ä»£ç†è®¾ç½®å®Œæˆ"`,
  ]

  return `${lines.join('\n')}\n`
}

function buildUnsetProxyShell(): string {
  const lines = [
    `# generated by bun proxy.ts`,
    `echo "ğŸ”§ æ¸…é™¤ä»£ç†..."`,
    `unset http_proxy HTTP_PROXY https_proxy HTTPS_PROXY no_proxy NO_PROXY`,
    `git config --global --unset http.proxy 2>/dev/null || true`,
    `git config --global --unset https.proxy 2>/dev/null || true`,
    `echo "âœ… ä»£ç†å·²æ¸…é™¤"`,
  ]
  return `${lines.join('\n')}\n`
}

function printUsage(): void {
  console.error(
    [
      'ç”¨æ³•:',
      '  proxy.ts set   [options]  # ç”Ÿæˆè®¾ç½®ä»£ç†çš„ shell ç‰‡æ®µ',
      '  proxy.ts unset           # ç”Ÿæˆæ¸…é™¤ä»£ç†çš„ shell ç‰‡æ®µ',
      '',
      'ç¤ºä¾‹ï¼ˆåœ¨ zsh ä¸­åŒ…ä¸€å±‚å‡½æ•°ï¼‰:',
      '  setProxy() { eval "$(~/.zsh/functions/bun/proxy.ts set "$@")" }',
      '  unsetProxy() { eval "$(~/.zsh/functions/bun/proxy.ts unset "$@")" }',
    ].join('\n'),
  )
}

async function main() {
  const [, , sub, ...rest] = process.argv

  if (!sub || sub === '-h' || sub === '--help') {
    printUsage()
    process.exit(sub
      ? 0
      : 1)
  }

  if (sub !== 'set' && sub !== 'unset') {
    console.error(`æœªçŸ¥å­å‘½ä»¤: ${sub}`)
    printUsage()
    process.exit(1)
  }

  try {
    if (sub === 'set') {
      const opts = parseSetArgs(rest)
      process.stdout.write(buildSetProxyShell(opts))
    }
    else if (sub === 'unset') {
      process.stdout.write(buildUnsetProxyShell())
    }
    process.exit(0)
  }
  catch (err) {
    console.error((err as Error).message)
    process.exit(1)
  }
}

main()
